package main

import (
	"bytes"
	"fmt"
	"strings"
)

// generatedHeader is the marker for generated documentation.
const generatedHeader = "<!-- Code generated by scripts/gendocs. DO NOT EDIT. -->"

// MarkdownWriter provides utilities for generating markdown content.
type MarkdownWriter struct {
	buf bytes.Buffer
}

// NewMarkdownWriter creates a new MarkdownWriter.
func NewMarkdownWriter() *MarkdownWriter {
	return &MarkdownWriter{}
}

// String returns the accumulated markdown content.
func (w *MarkdownWriter) String() string {
	return w.buf.String()
}

// Bytes returns the accumulated markdown content as bytes.
func (w *MarkdownWriter) Bytes() []byte {
	return w.buf.Bytes()
}

// Frontmatter writes VitePress frontmatter.
func (w *MarkdownWriter) Frontmatter(title, description string) {
	w.buf.WriteString("---\n")
	fmt.Fprintf(&w.buf, "title: %s\n", title)
	fmt.Fprintf(&w.buf, "description: %s\n", description)
	w.buf.WriteString("---\n\n")
}

// GeneratedMarker writes the "do not edit" marker.
func (w *MarkdownWriter) GeneratedMarker() {
	w.buf.WriteString(generatedHeader)
	w.buf.WriteString("\n\n")
}

// Header writes a markdown header.
func (w *MarkdownWriter) Header(level int, text string) {
	for i := 0; i < level; i++ {
		w.buf.WriteByte('#')
	}
	w.buf.WriteByte(' ')
	w.buf.WriteString(text)
	w.buf.WriteString("\n\n")
}

// Paragraph writes a paragraph.
func (w *MarkdownWriter) Paragraph(text string) {
	w.buf.WriteString(text)
	w.buf.WriteString("\n\n")
}

// Text writes text without trailing newlines.
func (w *MarkdownWriter) Text(text string) {
	w.buf.WriteString(text)
}

// Line writes a single line with a newline.
func (w *MarkdownWriter) Line(text string) {
	w.buf.WriteString(text)
	w.buf.WriteByte('\n')
}

// Newline writes a blank line.
func (w *MarkdownWriter) Newline() {
	w.buf.WriteByte('\n')
}

// CodeBlock writes a fenced code block.
func (w *MarkdownWriter) CodeBlock(lang, code string) {
	w.buf.WriteString("```")
	w.buf.WriteString(lang)
	w.buf.WriteByte('\n')
	w.buf.WriteString(strings.TrimSpace(code))
	w.buf.WriteString("\n```\n\n")
}

// InlineCode wraps text in inline code backticks.
func InlineCode(text string) string {
	return "`" + text + "`"
}

// Bold wraps text in bold markers.
func Bold(text string) string {
	return "**" + text + "**"
}

// BulletList writes a bullet list.
func (w *MarkdownWriter) BulletList(items []string) {
	for _, item := range items {
		fmt.Fprintf(&w.buf, "- %s\n", item)
	}
	w.buf.WriteByte('\n')
}

// Table writes a markdown table.
// headers defines the column headers.
// rows is a slice of rows, each row being a slice of cells.
func (w *MarkdownWriter) Table(headers []string, rows [][]string) {
	if len(headers) == 0 {
		return
	}

	// Write header row
	w.buf.WriteByte('|')
	for _, h := range headers {
		fmt.Fprintf(&w.buf, " %s |", h)
	}
	w.buf.WriteByte('\n')

	// Write separator
	w.buf.WriteByte('|')
	for range headers {
		w.buf.WriteString("--------|")
	}
	w.buf.WriteByte('\n')

	// Write data rows
	for _, row := range rows {
		w.buf.WriteByte('|')
		for i := range headers {
			cell := ""
			if i < len(row) {
				cell = row[i]
			}
			fmt.Fprintf(&w.buf, " %s |", cell)
		}
		w.buf.WriteByte('\n')
	}
	w.buf.WriteByte('\n')
}

// escapeMarkdown escapes special markdown characters in text.
func escapeMarkdown(text string) string {
	// Escape pipe characters in table cells
	text = strings.ReplaceAll(text, "|", "\\|")
	return text
}

// cleanDescription cleans up a description string for markdown.
func cleanDescription(desc string) string {
	// Remove leading/trailing whitespace
	desc = strings.TrimSpace(desc)
	// Replace newlines with spaces for table cells
	desc = strings.ReplaceAll(desc, "\n", " ")
	// Escape markdown
	desc = escapeMarkdown(desc)
	return desc
}
