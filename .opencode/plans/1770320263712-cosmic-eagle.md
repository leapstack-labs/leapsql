# CSS Refactoring: Deprecate Themes, Adopt Semantic Tokens

## Overview
Refactor all component CSS to use semantic design tokens (`--ui-*`) from `tokens/semantic.css` instead of theme-specific variables and hardcoded values. Deprecate the `themes/` directory while preserving the ability to support light/dark mode through CSS `light-dark()` function.

## Important Discovery: Two CSS Entry Points

The codebase has **two separate CSS systems** that need to be unified:

1. **base.css** (1382 bytes, 41 lines) - Modern modular system
   - Imports themes (lines 4-6)
   - Imports base styles and components
   - Used by some newer pages

2. **main.css** (21804 bytes, 1209 lines) - Legacy monolithic file
   - Hardcoded `:root` variables (lines 2-22)
   - All styles in one file
   - Contains duplicate/conflicting definitions
   - Still in use somewhere

**Migration strategy:** 
- Replace all main.css usage with base.css + semantic tokens
- Find all template files importing main.css and switch to base.css
- Delete main.css after migration

## Current State Analysis

### Token System Architecture
```
Tier 1: Primitives (--op-*)
├── Open Props: borders, easings, fonts, shadows, sizes (~264 tokens)
└── Material Palettes: color generation (--md-palette-*)

Tier 2: Semantic (--ui-*) [APPLICATION API]
└── semantic.css - Maps primitives to semantic names
    ├── Colors: Uses light-dark() for automatic theme switching
    ├── Spacing: 6 fixed + 6 fluid scales
    ├── Typography: 9 sizes, 6 line heights, 5 weights, 3 font families
    ├── Borders: 4 radii, 3 widths
    ├── Shadows: 4 levels
    ├── Animation: 4 easings, 4 durations
    └── Layout: z-index, breakpoints, content widths

Tier 3: Legacy Themes (TO BE DEPRECATED)
└── themes/ - Hand-crafted theme-specific variables
    ├── claude.css (79 variables) - Loaded via base.css line 4
    ├── vercel.css (79 variables) - Loaded via base.css line 5
    └── catppuccin.css (89 variables with sidebar extras) - Loaded via base.css line 6

Legacy CSS (TO BE REPLACED)
└── main.css - 1209 lines of hardcoded values and old variables
```

### Theme System Details
- **HTML attributes:** `data-theme="[claude|vercel|catppuccin]"` + `.dark` class
- **Theme initialization:** Anti-FOUC script in `base.templ:24-34`
- **Datastar signals:** `$theme` (theme name), `$darkMode` (boolean)
- **Storage:** `localStorage.getItem('theme')` and `localStorage.getItem('darkMode')`
- **Theme controls:** Three theme buttons in `layout.templ:15-37`
- **Default theme:** 'claude' (hardcoded in base.templ:7,9,26)

### Component Analysis
- **19 component files** using mix of theme variables and hardcoded values
- **272 hardcoded spacing values** (4px, 8px, 12px, 16px, etc.)
- **92 hardcoded font sizes** (10px, 12px, 14px, 16px, etc.)
- **32 color-mix() instances** for transparency effects
- **17 hardcoded border radii** for special cases
- **Mixed animation timing** patterns

### Priority Files for Refactoring
1. **runs.css** (851 lines) - 26 color-mix, ~30 font sizes, ~60 spacing values
2. **query.css** (394 lines) - Already uses some spacing tokens (good model)
3. **macros.css** (274 lines) - ~15 font sizes, ~40 spacing values
4. **database.css** (200 lines) - Chart colors, ~15 font sizes
5. **graph.css** (169 lines) - Chart colors, ~12 font sizes
6. **header.css** (150 lines) - Glassmorphism effects
7. **All remaining components** (13 files, mostly smaller)

## Migration Strategy

### Phase 1: Discovery and Mapping
**Goal:** Understand exactly what needs to be migrated and create mappings

**Tasks:**
1. **Find all main.css usage:**
   - Search for `href="/static/css/main.css"` or `import url('./main.css')`
   - Document which templates/pages use main.css vs base.css
   - Plan to switch all to base.css

2. **Create migration mapping table:**
   
   | Old Variable (main.css) | Old Variable (themes/*.css) | New Token (semantic.css) | Notes |
   |-------------------------|----------------------------|--------------------------|-------|
   | `--color-bg` | `--background` | `--ui-color-background` | Main bg |
   | `--color-bg-secondary` | `--card` | `--ui-color-surface-container` | Cards |
   | `--color-bg-tertiary` | `--muted` | `--ui-color-surface-container-low` | Subtle bg |
   | `--color-border` | `--border` | `--ui-color-outline` | Borders |
   | `--color-text` | `--foreground` | `--ui-color-background-on` | Primary text |
   | `--color-text-muted` | `--muted-foreground` | `--ui-color-surface-variant-on` | Secondary text |
   | `--color-primary` | `--primary` | `--ui-color-primary` | Primary actions |
   | `--color-primary-hover` | N/A | `--ui-color-primary` + hover | Remove variable |
   | `--color-success` | `--accent` | `--ui-color-tertiary` | Success/accent |
   | `--color-warning` | N/A | Use `oklch(0.75 0.15 85)` | Hardcode if rare |
   | `--color-error` | `--destructive` | `--ui-color-error` | Error states |
   | `--font-sans` | `--font-sans` | `--ui-font-body` | Body text |
   | `--font-mono` | `--font-mono` | `--ui-font-code` | Code/mono |
   
3. **Document hardcoded value patterns:**
   - Spacing: 2px→xs, 4px→xs, 8px→sm, 12px→md, 16px→md, 24px→lg, 32px→xl
   - Font sizes: Map to `--ui-type-size-*` scale
   - Border radius: Map to `--ui-radius-*` scale

4. **Identify opacity patterns for color-mix:**
   - Error backgrounds: `5%`, `10%`, `15%` (various)
   - Running/primary states: `5%`
   - Success states: `15%`
   - These will use: `color-mix(in oklch, var(--ui-color-error) 10%, transparent)`

**Output:** Complete migration guide with mappings

### Phase 2: Audit Semantic Token Coverage
**Goal:** Verify semantic.css has all tokens needed for migration

**Tasks:**
1. Check existing tokens against component requirements:
   - ✅ Border radii: `--ui-radius-sm` (2px), `--ui-radius-md`, `--ui-radius-lg`, `--ui-radius-full`
   - ✅ Spacing: Already has `--ui-space-xs` (2px) through `--ui-space-2xl` (32px)
   - ✅ Typography: Already has `--ui-type-size-xs` through `--ui-type-size-4xl`
   - ✅ Font families: Already has `--ui-font-body`, `--ui-font-code`, `--ui-font-heading`
   - ✅ Shadows: Already has `--ui-shadow-sm` through `--ui-shadow-xl`
   - ✅ Colors: Comprehensive palette with light-dark() support

2. Document token gaps (if any) and add missing tokens if needed

3. Verify `--ui-radius-none: 0` exists for explicit no-radius cases

**Files to check:**
- `internal/ui/resources/static/css/tokens/semantic.css`

**Expected outcome:** Semantic tokens are already comprehensive. Minimal or no changes needed.

### Phase 3: Component Migration (Systematic)
**Goal:** Refactor main.css and all component files to use semantic tokens

**Critical first step:**
- **Verify main.css usage:** Search all .templ files for references to main.css
- If main.css is NOT imported anywhere, it can be safely deleted (orphaned file)
- If main.css IS imported, need to:
  1. Refactor its styles to semantic tokens
  2. Move unique styles to appropriate component files
  3. Switch templates to import base.css instead

**Order of execution:**

1. **main.css → Decision point** (1209 lines)
   - LARGEST FILE - highest impact
   - Search for: `main.css` in all templates
   - If unused: DELETE (safe, no refactor needed)
   - If used: Refactor all styles → semantic tokens, then switch imports

2. **query.css** (394 lines) - Model file already partially tokenized
3. **Small components** (forms.css, cards.css, buttons.css) - Quick wins
4. **runs.css** (851 lines) - Complex status colors and states
5. **macros.css** (274 lines) - Many hardcoded values
6. **Visualization components** (database.css, graph.css)
7. **Layout components** (header.css, sidebar.css, activity-bar.css)
8. **Remaining components** (13 smaller files)

**Refactoring patterns:**

#### Colors
```css
/* BEFORE */
background: var(--card);
color: var(--foreground);
border: 1px solid var(--border);

/* AFTER */
background: var(--ui-color-surface-container);
color: var(--ui-color-surface-on);
border: 1px solid var(--ui-color-outline);
```

#### Spacing
```css
/* BEFORE */
padding: 8px 12px;
gap: 4px;

/* AFTER */
padding: var(--ui-space-sm) var(--ui-space-md);
gap: var(--ui-space-xs);
```

#### Typography
```css
/* BEFORE */
font-size: 14px;
font-weight: 500;
line-height: 1.5;

/* AFTER */
font-size: var(--ui-type-size-base);
font-weight: var(--ui-weight-medium);
line-height: var(--ui-leading-normal);
```

#### Border Radius
```css
/* BEFORE */
border-radius: 6px;
border-radius: 50%; /* circle */

/* AFTER */
border-radius: var(--ui-radius-md);
border-radius: var(--ui-radius-full);
```

#### Shadows
```css
/* BEFORE */
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);

/* AFTER */
box-shadow: var(--ui-shadow-md);
```

#### Animation
```css
/* BEFORE */
transition: all 150ms ease;

/* AFTER */
transition: all var(--ui-duration-fast) var(--ui-ease-default);
```

#### Color Transparency (Special Cases)
```css
/* BEFORE */
background: color-mix(in oklch, var(--destructive) 10%, transparent);

/* AFTER - Option 1: Pre-defined state colors */
background: var(--ui-color-error-bg);

/* AFTER - Option 2: Keep color-mix with semantic tokens */
background: color-mix(in oklch, var(--ui-color-error) 10%, transparent);
```

**Files to modify:** All 19 component files in `internal/ui/resources/static/css/components/`

### Phase 4: Deprecate Themes and Legacy CSS
**Goal:** Remove theme files, legacy CSS, and update imports

**Tasks:**
1. **Delete legacy files:**
   - Delete `internal/ui/resources/static/css/themes/` (entire directory)
   - Delete `internal/ui/resources/static/css/main.css` (1209 lines of old variables/hardcoded values)

2. **Update base.css imports:**
   - Remove lines 4-6: Theme imports (claude.css, vercel.css, catppuccin.css)
   - Add import for semantic tokens before base imports: `@import url('./tokens/index.css');`

3. **Verify token loading order:**
   ```css
   /* NEW STRUCTURE */
   @import url('./tokens/index.css');  /* Loads all tokens including semantic.css */
   @import url('./base/reset.css');
   @import url('./base/variables.css');
   @import url('./base/typography.css');
   @import url('./base/layout.css');
   @import url('./base/utilities.css');
   @import url('./base/transitions.css');
   /* ... components ... */
   ```

**Files to modify:**
- `internal/ui/resources/static/css/base.css` (update imports)

**Files to delete:**
- `internal/ui/resources/static/css/themes/` (entire directory: claude.css, vercel.css, catppuccin.css)
- `internal/ui/resources/static/css/main.css` (replaced by migrated component files)

### Phase 5: Simplify Theme Switching to Light/Dark Only
**Goal:** Remove multi-theme support, keep only dark mode toggle

**Tasks:**
1. **Update base.templ (`internal/ui/features/common/layouts/base.templ`):**
   - Line 7: Remove `theme: 'claude'` from data-signals
   - Line 9: Remove `$theme = localStorage.getItem('theme') || 'claude';`
   - Line 13: Remove `$activePanel = localStorage.getItem('activePanel') || 'explorer'` (keep line 12)
   - Line 16: Remove `data-attr:data-theme="$theme"` (no longer needed)
   - Lines 26-27: Remove theme from localStorage logic in anti-FOUC script
   - Line 32: Remove `document.documentElement.setAttribute('data-theme', theme);`
   - **Keep:** Dark mode logic (lines 10-11, 28-31) - this still works with semantic.css

2. **Update layout.templ (`internal/ui/features/common/components/layout.templ`):**
   - Remove three theme selector buttons (lines ~15-37):
     - Claude theme button
     - Vercel theme button
     - Catppuccin theme button
   - **Keep:** Dark mode toggle button (should exist nearby)

3. **Update semantic.css if needed:**
   - Lines 181-182 currently have `data-theme="light"` and `data-theme="dark"` selectors
   - These may no longer be necessary since we're using `light-dark()` function
   - Verify `color-scheme: light dark` on `:root` is sufficient

4. **Test dark mode switching:**
   - Toggle `.dark` class works
   - localStorage persistence works
   - System preference detection works
   - All colors adapt via `light-dark()` function

**Files to modify:**
- `internal/ui/features/common/layouts/base.templ`
- `internal/ui/features/common/components/layout.templ`
- `internal/ui/resources/static/css/tokens/semantic.css` (potentially)

### Phase 6: Clean Up and Documentation
**Goal:** Remove unused variables, add documentation

**Tasks:**
1. Search for any remaining references to old theme variables
2. Remove unused CSS variables from any base files
3. Add comments to semantic.css explaining token usage
4. Update any developer documentation about theming
5. Add migration notes if needed

**Files to check:**
- `internal/ui/resources/static/css/base/variables.css` (layout vars only)
- Any documentation files

## Testing Strategy

### Visual Regression Testing
1. **Light Mode:** Verify all components render correctly
2. **Dark Mode:** Toggle and verify all components adapt
3. **Responsive:** Test at mobile, tablet, desktop breakpoints
4. **Component States:** Hover, focus, active, disabled
5. **Special Cases:** 
   - Runs table with status colors
   - Query editor syntax highlighting
   - Graph/chart visualizations
   - Modal overlays and glassmorphism

### Browser Testing
- Chrome/Edge (latest)
- Firefox (latest)
- Safari (latest)

### Automated Testing
- Run existing CSS linting: `task lint`
- Verify no broken builds: `task check`

## Success Criteria

- [ ] Zero references to `--background`, `--foreground`, `--card`, etc. (old theme vars)
- [ ] Zero hardcoded spacing values (use `--ui-space-*`)
- [ ] Zero hardcoded font sizes (use `--ui-type-size-*`)
- [ ] Zero hardcoded border radii except `0` (use `--ui-radius-*`)
- [ ] All color-mix() uses semantic tokens or pre-defined state colors
- [ ] `themes/` directory deleted
- [ ] Light/dark mode switching works seamlessly
- [ ] All components visually identical to original
- [ ] No console errors or broken styles

## Risk Mitigation

### High Risk Areas
1. **Runs table complexity** - Many color states, large file
2. **Chart colors** - Visualization consistency critical
3. **Glassmorphism effects** - Subtle transparency calculations

### Mitigation Strategies
1. Take screenshots before/after for visual comparison
2. Migrate one component at a time, test thoroughly
3. Keep git history clean for easy rollback
4. Consider feature flag if this goes to production mid-development

## User Decisions

1. **Theme approach:** Single unified design system (deprecate Claude/Vercel/Catppuccin themes) ✅
2. **Color-mix strategy:** Keep inline color-mix() with semantic tokens (no pre-defined state colors) ✅
3. **Font families:** Use Open Props system fonts only (--op-font-sans, --op-font-mono) ✅
4. **Chart colors:** Not applicable - no charts in the UI ✅
5. **Migration approach:** All components at once (single PR, clean break) ✅

## Files Reference

### Critical Files
- `internal/ui/resources/static/css/tokens/semantic.css` - Semantic token definitions (THE API)
- `internal/ui/resources/static/css/tokens/index.css` - Token entry point
- `internal/ui/resources/static/css/base.css` - Main CSS entry point (imports all)
- `internal/ui/features/common/layouts/base.templ` - HTML base layout with theme init
- `internal/ui/features/common/components/layout.templ` - Header with theme controls

### Components (19 files)
**Note:** These currently import from base.css. After migration, they'll use semantic tokens directly.
- `internal/ui/resources/static/css/components/activity-bar.css`
- `internal/ui/resources/static/css/components/buttons.css`
- `internal/ui/resources/static/css/components/cards.css`
- `internal/ui/resources/static/css/components/content.css`
- `internal/ui/resources/static/css/components/context-panel.css`
- `internal/ui/resources/static/css/components/database.css`
- `internal/ui/resources/static/css/components/forms.css`
- `internal/ui/resources/static/css/components/graph.css`
- `internal/ui/resources/static/css/components/header.css`
- `internal/ui/resources/static/css/components/log-drawer.css`
- `internal/ui/resources/static/css/components/macros.css`
- `internal/ui/resources/static/css/components/model-detail.css`
- `internal/ui/resources/static/css/components/query.css`
- `internal/ui/resources/static/css/components/runs.css`
- `internal/ui/resources/static/css/components/side-panel.css`
- `internal/ui/resources/static/css/components/sidebar.css`
- `internal/ui/resources/static/css/components/sql-editor.css`
- `internal/ui/resources/static/css/components/tables.css`
- `internal/ui/resources/static/css/components/tree.css`

### To Delete
- `internal/ui/resources/static/css/themes/` (entire directory with 3 files)
  - `catppuccin.css` (214 lines)
  - `claude.css` (185 lines)
  - `vercel.css` (182 lines)
- `internal/ui/resources/static/css/main.css` (1209 lines - replaced by component migrations)

**Total deletion: 1,790 lines of deprecated CSS**

## Estimated Effort
- **Phase 1 (Documentation audit):** 1-2 hours
- **Phase 2 (Token verification):** 0.5-1 hour (tokens look complete)
- **Phase 3 (Component migration):** 10-14 hours
  - main.css (1209 lines) → semantic tokens
  - 19 component files (varying complexity)
- **Phase 4 (Delete themes/legacy):** 0.5 hour
- **Phase 5 (Simplify theme logic):** 1-2 hours
- **Phase 6 (Testing & cleanup):** 2-3 hours

**Total: 15-22.5 hours** (2-3 full working days)
